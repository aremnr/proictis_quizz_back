<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile</title>
    <script type="module" src="/static/QRCreator.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .button {
            display: block;
            margin: 10px 0;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }
        .link-button {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
        }
        .link-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Admin Profile</h1>
    <button id="create-referral-btn" class="button">Create Referral</button>
    <div id="referral-result" class="result hidden"></div>

    <button id="create-game-btn" class="button">Create Game</button>

    <div id="game-form" class="hidden">
        <input type="text" id="quiz-id-input" placeholder="Enter Quiz ID">
        <button id="submit-game-btn" class="button">Submit</button>
    </div>
    <div id="game-result" class="result hidden">
        <button class="hidden button" id="go-to-admin-page-btn">Go to Game</button>
        <div class="hidden" id="qrcode"></div>
    </div>

    <div id = "quizzes">

    </div>

    <button id="GoTOCreate" class="button">
        Создать Квиз
    </button>
    <script>
        quiz_div = document.getElementById("quizzes")
        quizzes = JSON.parse(localStorage.getItem('quizzes'))
        for (let i = 0; i < quizzes.length; i++) {
            quiz_id_button = document.createElement("button")
            quiz_id_button.setAttribute('onclick', 'copyText(this)')
            quiz_id_button.id = `${quizzes[i].id}`
            quiz_id_button.textContent = `${quizzes[i].name}`
            quiz_div.appendChild(quiz_id_button)
        }
        function copyText(button) {
            // Создаем временное поле для копирования текста
            const tempInput = document.createElement("input");
            tempInput.value = button.id;
            button_text = button.innerText
            document.body.appendChild(tempInput);

            // Выделяем текст и копируем его
            tempInput.select();
            document.execCommand("copy");

            // Удаляем временное поле
            document.body.removeChild(tempInput);

            // Меняем текст кнопки на "Скопировано!"
            button.innerText = "Скопировано!";

            // Возвращаем исходный текст через 2 секунды
            setTimeout(() => {
                button.innerText = button_text;
            }, 2000);
        }

        document.getElementById('GoTOCreate').addEventListener('click', function () {
            window.location.href = "/create_quiz";
        })

        document.getElementById('create-referral-btn').addEventListener('click', function() {
            const token = localStorage.getItem('authToken');
            fetch('/create_referral', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const referralResult = document.getElementById('referral-result');
                referralResult.textContent = `Referral: ${data.referral}`;
                referralResult.classList.remove('hidden');
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('create-game-btn').addEventListener('click', function() {
            const gameForm = document.getElementById('game-form');
            gameForm.classList.remove('hidden');
        });

        document.getElementById('submit-game-btn').addEventListener('click', function() {
            const quizId = document.getElementById('quiz-id-input').value;
            const token = localStorage.getItem('authToken');
            fetch(`/create_game?quiz_id=${quizId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const gameResult = document.getElementById('game-result');
                const gameButton = document.getElementById("go-to-admin-page-btn");
                const qrcode = document.getElementById("qrcode");
                gameButton.classList.remove('hidden')
                gameResult.classList.remove('hidden')
                qrcode.classList.remove('hidden')
                qrcode.append(QRCreator(`http://${window.location.host}/user_add/${data.game_id}`).result);
                localStorage.setItem('gameId', `${data.game_id}`)
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('go-to-admin-page-btn').addEventListener('click', function () {
            game_id = localStorage.getItem('gameId')

            token = localStorage.getItem('authToken')
            fetch(`/admin_game/${game_id}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        }
                        throw new Error('Network response was not ok.');
                    })
                    .then(html => {
                        // Assuming you want to replace the current page with the response
                        document.open();
                        document.write(html);
                        document.close();
                    })
                    .catch(error => {
                        console.error('Fetch operation failed: ', error);
                    });
            
        })
    </script>
</body>
</html>
